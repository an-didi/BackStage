<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>港湾后台文章管理页面</title>
    <!-- Tell the browser to be responsive to screen width -->
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="{__PLUGINS__}/fontawesome-free/css/all.min.css">
    <!-- Ionicons -->
    <link rel="stylesheet" href="https://code.ionicframework.com/ionicons/2.0.1/css/ionicons.min.css">
    <!-- Tempusdominus Bbootstrap 4 -->
    <link rel="stylesheet" href="{__PLUGINS__}/tempusdominus-bootstrap-4/css/tempusdominus-bootstrap-4.min.css">
    <!-- iCheck -->
    <link rel="stylesheet" href="{__PLUGINS__}/icheck-bootstrap/icheck-bootstrap.min.css">
    <!-- JQVMap -->
    <link rel="stylesheet" href="{__PLUGINS__}/jqvmap/jqvmap.min.css">
    <!-- Theme style -->
    <link rel="stylesheet" href="{__DIST__}/css/adminlte.min.css">
    <!-- overlayScrollbars -->
    <link rel="stylesheet" href="{__PLUGINS__}/overlayScrollbars/css/OverlayScrollbars.min.css">
    <!-- Daterange picker -->
    <link rel="stylesheet" href="{__PLUGINS__}/daterangepicker/daterangepicker.css">
    <!-- summernote -->
    <link rel="stylesheet" href="{__PLUGINS__}/summernote/summernote-bs4.css">
    <!-- DataTables -->
    <link rel="stylesheet" href="{__PLUGINS__}/datatables-bs4/css/dataTables.bootstrap4.min.css">
    <link rel="stylesheet" href="{__PLUGINS__}/datatables-responsive/css/responsive.bootstrap4.min.css">
</head>
<body class="hold-transition sidebar-mini layout-fixed">
<div class="wrapper">

    <!-- Content Wrapper. Contains page content -->
    <div>
        <!-- Content Header (Page header) -->
        <div class="content-header">
            <div class="container-fluid">
                <div class="row mb-2">
                    <div class="col-sm-6">
                        <small>
                            <a href="{:url('/article/index')}" class="btn btn-success"><i class="fas fa-list"></i>文章列表</a>
                        </small>
                    </div>
                    <div class="col-sm-6">
                        <ol class="breadcrumb float-sm-right">
                            <li class="breadcrumb-item"><a href="/index/welcome"><i class="fas fa-home"></i>首页</a></li>
                            <li class="breadcrumb-item active">回收站</li>
                        </ol>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main content -->
        <section class="content">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">文章管理</h3>
                </div>
                <!-- /.card-header -->
                <form name="delform" method="post">
                    <div class="card-body">
                        <table id="example1" class="table table-bordered table-striped">
                            <thead>
                            <tr>
                                <th>
                                    <input type="checkbox" name="select-all" id="select-all">
                                </th>
                                <th>编号</th>
                                <th>标题</th>
                                <th>类别</th>
                                <th>作者</th>
                                <th>时间</th>
                                <th>状态</th>
                                <th>操作</th>
                            </tr>
                            </thead>
                            <tfoot>
                            <tr>
                                <th colspan="8">
                                    <input type="submit" class="btn btn-primary" name="sub"
                                           value="批量还原"
                                           onclick="if(confirm('移到回收站后将不显示，可以从回收站列表找回？')){document.delform.action='{:url('/article/revertAll')}';document.delform.submit();}else{return false;}">
                                </th>
                            </tr>
                            </tfoot>
                        </table>
                    </div>
                </form>
                <!-- /.card-body -->
            </div>
        </section>
    </div>


</div>
<!-- jQuery -->
<script src="{__PLUGINS__}/jquery/jquery.min.js"></script>
<!-- Bootstrap 4 -->
<script src="{__PLUGINS__}/bootstrap/js/bootstrap.bundle.min.js"></script>
<!-- AdminLTE App -->
<script src="{__DIST__}/js/adminlte.js"></script>
<!-- DataTables -->
<script src="{__PLUGINS__}/datatables/jquery.dataTables.min.js"></script>
<script src="{__PLUGINS__}/datatables-bs4/js/dataTables.bootstrap4.min.js"></script>
<script src="{__PLUGINS__}/datatables-responsive/js/dataTables.responsive.min.js"></script>
<script src="{__PLUGINS__}/datatables-responsive/js/responsive.bootstrap4.min.js"></script>
<!-- layui.js -->
<script src="/static/adminstatic/layui/layui.js"></script>
<script type="text/javascript">
    layui.use(['layer'],function (){
        layer = layui.layer;
    });
    // datatables初始化
    $(function () {
        $("#example1").DataTable({
            "rowId":"id",
            "autoWidth": false,
            // 开启服务端
            "serverSide": true,
            // 保存当前页的状态
            "stateSave":true,
            "stateDuration":-1,
            // 异步请求ajax
            "ajax":{
                "url":"/article/recycleBin",
                "type":"POST",
                "dataType":"JSON",
                "dataSrc":"tableData"
            },
            //对数据的列进行个性化设置,需要与数据的列进行一一对应
            "columns":[
                {
                    "data":null,
                    "orderable":false,
                },
                {
                    "data":"id",
                    "name":"编号",
                },
                {
                    "data":"title",
                    "name":"标题",
                    "orderable":false,
                },
                {
                    "data": "catname",
                    "name": "类别",
                    "orderable": false,
                },
                {
                    "data": "uname",
                    "name": "作者",
                    "orderable": false,
                },
                {
                    "data":"create_time",
                    "name":"创建时间",
                    "orderable": false,
                },
                {
                    "data":"status",
                    "name":"状态",
                    "orderable":false,
                },

            ],
            "columnDefs":[
                {
                    "targets":0,
                    "orderable": false,
                    "render": function (data, type, row, meta){
                        return "<input type='checkbox' class='single-check' name='ids[]' id='ids[]' value='"+ row.id +"'>"
                    }
                },
                {
                    "targets": 7,
                    "orderable": false,
                    "render": function (data, type, row, meta){
                        let html = '';
                        html += `<a title='还原到文章列表' class='btn btn-primary' id=${row.id} onclick="layer.confirm('移除后列表将不再显示，可以从回收站中找回。确定要移除吗？', {'icon':3, 'title':'提示'}, function (index){recycle('${row.id}','0');layer.close(index);});"><i class='fas fa-recycle'></i></a>`;
                        html += "&nbsp;&nbsp;";
                        html += `<a title='删除' class='btn btn-danger' id=${row.id} onclick="layer.confirm('删除后将无法撤销，确定要删除吗？', {'icon':3, 'title':'提示'}, function (index){del('${row.id}');layer.close(index);});"><i class='fas fa-trash-alt'></i></a>`;
                        return html;
                    }
                },
            ],
            "language":{
                "processing": "处理中...",
                "lengthMenu": "显示 _MENU_ 项结果",
                "zeroRecords": "没有匹配结果",
                "info": "显示第 _START_ 至 _END_ 项结果，共 _TOTAL_ 项",
                "infoEmpty": "显示第 0 至 0 项结果，共 0 项",
                "infoFiltered": "(由 _MAX_ 项结果过滤)",
                "infoPostFix": "",
                "search": "搜索:",
                "searchPlaceholder": "搜索...",
                "url": "",
                "emptyTable": "表中数据为空",
                "loadingRecords": "载入中...",
                "infoThousands": ",",
                "paginate": {
                    "first": "首页",
                    "previous": "上页",
                    "next": "下页",
                    "last": "末页"
                },
                "aria": {
                    "paginate": {
                        "first": "首页",
                        "previous": "上页",
                        "next": "下页",
                        "last": "末页"
                    },
                    "sortAscending": "以升序排列此列",
                    "sortDescending": "以降序排列此列"
                },
                "thousands": "."
            },
        });
    });

    //checkbox 全选/反选
    $(function (){
        $('#select-all').on('change', function (ev) {
            $('.single-check').each(function () {
                this.checked = ev.target.checked;
            });
        });
        // console.log($('#select-all'));
        // console.log($('.single-check'));
        // 反选出了问题，获取不到dom元素
        $('.single-check').each(function (){
            this.on('click', function (){
                console.log($("#check-all")[0].checked);
                $("#select-all")[0].checked = [...$('.single-check')].every((item) => item.checked);
            })
        });
    });

    // 移入回收站
    function recycle(id, type){
        $.ajax({
            url: '/article/recycle',
            dataType:'json',
            type: 'POST',
            data: {'id': id, 'type': type},
            success: function (e) {
                // 异步删除成功，页面局部刷新
                if (e.code > 0) {
                    $('#' + id).remove();
                    layer.msg('还原成功', {
                        'icon': 1
                    });
                } else {
                    layer.msg('还原失败', {
                        'icon': 2
                    });
                }
            }
        });
    }

    // 删除文章
    function del(id) {
        $.ajax({
            url: '/article/del',
            dataType: 'json',
            type: 'POST',
            data: {'id': id},
            success: function (e) {
                // 异步删除成功，页面局部刷新
                if (e.code > 0) {
                    $('#' + id).remove();
                    layer.msg(e.msg, {
                        'icon': 1
                    });
                } else {
                    layer.msg(e.msg, {
                        'icon': 2
                    });
                }
            }
        });
    }
</script>
</body>
</html>
